<!-- Scripts -->
<script type="module">
import { connect, Contract, keyStores, WalletConnection } from 'near-api-js'
const CONTRACT_NAME = 'damnit.fakenear.testnet'

function getConfig(env) {
  switch (env) {

  case 'production':
  case 'mainnet':
    return {
      networkId: 'mainnet',
      nodeUrl: 'https://rpc.mainnet.near.org',
      contractName: CONTRACT_NAME,
      walletUrl: 'https://wallet.near.org',
      helperUrl: 'https://helper.mainnet.near.org',
      explorerUrl: 'https://explorer.mainnet.near.org',
    }
  case 'development':
  case 'testnet':
    return {
      networkId: 'testnet',
      nodeUrl: 'https://rpc.testnet.near.org',
      contractName: CONTRACT_NAME,
      walletUrl: 'https://wallet.testnet.near.org',
      helperUrl: 'https://helper.testnet.near.org',
      explorerUrl: 'https://explorer.testnet.near.org',
    }
  case 'betanet':
    return {
      networkId: 'betanet',
      nodeUrl: 'https://rpc.betanet.near.org',
      contractName: CONTRACT_NAME,
      walletUrl: 'https://wallet.betanet.near.org',
      helperUrl: 'https://helper.betanet.near.org',
      explorerUrl: 'https://explorer.betanet.near.org',
    }
  case 'local':
    return {
      networkId: 'local',
      nodeUrl: 'http://localhost:3030',
      keyPath: `${process.env.HOME}/.near/validator_key.json`,
      walletUrl: 'http://localhost:4000/wallet',
      contractName: CONTRACT_NAME,
    }
  case 'test':
  case 'ci':
    return {
      networkId: 'shared-test',
      nodeUrl: 'https://rpc.ci-testnet.near.org',
      contractName: CONTRACT_NAME,
      masterAccount: 'test.near',
    }
  case 'ci-betanet':
    return {
      networkId: 'shared-test-staging',
      nodeUrl: 'https://rpc.ci-betanet.near.org',
      contractName: CONTRACT_NAME,
      masterAccount: 'test.near',
    }
  default:
    throw Error(`Unconfigured environment '${env}'. Can be configured in src/config.js.`)
  }
}

const nearConfig = getConfig('development')
const near = await connect(Object.assign({ deps: { keyStore: new keyStores.BrowserLocalStorageKeyStore() } }, nearConfig))

// Initializing Wallet based Account. It can work with NEAR testnet wallet that
// is hosted at https://wallet.testnet.near.org
window.walletConnection = new WalletConnection(near)

// Getting the Account ID. If still unauthorized, it's just empty string
window.accountId = window.walletConnection.getAccountId()

// Initializing our contract APIs by contract name and configuration
window.contract = await new Contract(window.walletConnection.account(), nearConfig.contractName, {
  // View methods are read only. They don't modify the state, but usually return some value.
  viewMethods: [],
  // Change methods can modify the state. But you don't receive the returned value when called.
  changeMethods: [],
})

function logout() {
  window.walletConnection.signOut()
  // reload page
  window.location.replace(window.location.origin + window.location.pathname)
}

function login() {
  // Allow the current app to make calls to the specified contract on the
  // user's behalf.
  // This works by creating a new access key for the user's account and storing
  // the private key in localStorage.
  window.walletConnection.requestSignIn(nearConfig.contractName)
}

window.login = login
window.logout = logout


// ==================================================================
// import { NFTStorage } from 'nft.storage'

// ERC-1155 metadata standards. 
async function store_nft(markdown_text, api_key) {
  var title = markdown_text.split("\n")[0].trim().substr(0, 50);

  var nft = {
    image: null,  // simple bro, no need image. 
    name: title,
    description: null,
    properties: {
      authors: [{ name: window.walletConnection.getAccountId() }],
      content: {
        "text/markdown": markdown_text
      }
    }
  }

  // var client = new NFTStorage({ token: api_key });
  // var metadata = await client.store(nft);

  var bearer = "Bearer " + api_key;

  fetch("https://api.nft.storage/upload", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": bearer
    },
    body: JSON.stringify(nft)
  }).then(
    resp => {
      if (resp.ok == true) {
        alert("Successfully saved.");
        console.log("Metadata:", resp);
        console.log("Metadata URI: ", resp.url);

        // Change to storing on the contract, the resp.url. 
      } else {
        alert("Failed to save.");
        console.log(resp.error);
      }
    }
  )
}

window.store_nft = store_nft
</script>