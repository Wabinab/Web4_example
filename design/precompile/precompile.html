<head>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WriteLog</title>

  <!-- Importmap -->
<script type="importmap">
  {
    "imports": {
      "near-api-js": "https://ga.jspm.io/npm:near-api-js@0.44.2/lib/browser-index.js",
      "base-x": "https://ga.jspm.io/npm:base-x@3.0.9/src/index.js",
      "bn.js": "https://ga.jspm.io/npm:bn.js@5.2.0/lib/bn.js",
      "borsh": "https://ga.jspm.io/npm:borsh@0.6.0/lib/index.js",
      "bs58": "https://ga.jspm.io/npm:bs58@4.0.1/index.js",
      "buffer": "https://ga.jspm.io/npm:@jspm/core@2.0.0-beta.19/nodelibs/browser/buffer.js",
      "capability": "https://ga.jspm.io/npm:capability@0.2.5/index.js",
      "capability/es5": "https://ga.jspm.io/npm:capability@0.2.5/es5.js",
      "crypto": "https://ga.jspm.io/npm:@jspm/core@2.0.0-beta.19/nodelibs/browser/crypto.js",
      "depd": "https://ga.jspm.io/npm:depd@2.0.0/lib/browser/index.js",
      "error-polyfill": "https://ga.jspm.io/npm:error-polyfill@0.1.3/index.js",
      "http-errors": "https://ga.jspm.io/npm:http-errors@1.8.1/index.js",
      "inherits": "https://ga.jspm.io/npm:inherits@2.0.4/inherits_browser.js",
      "js-sha256": "https://ga.jspm.io/npm:js-sha256@0.9.0/src/sha256.js",
      "mustache": "https://ga.jspm.io/npm:mustache@4.2.0/mustache.js",
      "o3": "https://ga.jspm.io/npm:o3@1.0.3/index.js",
      "process": "https://ga.jspm.io/npm:@jspm/core@2.0.0-beta.19/nodelibs/browser/process-production.js",
      "safe-buffer": "https://ga.jspm.io/npm:safe-buffer@5.2.1/index.js",
      "setprototypeof": "https://ga.jspm.io/npm:setprototypeof@1.2.0/index.js",
      "statuses": "https://ga.jspm.io/npm:statuses@1.5.0/index.js",
      "text-encoding-utf-8": "https://ga.jspm.io/npm:text-encoding-utf-8@1.0.2/lib/encoding.lib.js",
      "toidentifier": "https://ga.jspm.io/npm:toidentifier@1.0.1/index.js",
      "tweetnacl": "https://ga.jspm.io/npm:tweetnacl@1.0.3/nacl-fast.js",
      "u3": "https://ga.jspm.io/npm:u3@0.1.1/index.js",
      "marked": "https://ga.jspm.io/npm:marked@4.0.17/lib/marked.esm.js"
    }
  }
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
  <!-- Scripts -->
<script type="module">
import { connect, Contract, keyStores, WalletConnection } from 'near-api-js'
const CONTRACT_NAME = 'oregon.fakenear.testnet'

function getConfig(env) {
  switch (env) {

  case 'production':
  case 'mainnet':
    return {
      networkId: 'mainnet',
      nodeUrl: 'https://rpc.mainnet.near.org',
      contractName: CONTRACT_NAME,
      walletUrl: 'https://wallet.near.org',
      helperUrl: 'https://helper.mainnet.near.org',
      explorerUrl: 'https://explorer.mainnet.near.org',
    }
  case 'development':
  case 'testnet':
    return {
      networkId: 'testnet',
      nodeUrl: 'https://rpc.testnet.near.org',
      contractName: CONTRACT_NAME,
      walletUrl: 'https://wallet.testnet.near.org',
      helperUrl: 'https://helper.testnet.near.org',
      explorerUrl: 'https://explorer.testnet.near.org',
    }
  case 'betanet':
    return {
      networkId: 'betanet',
      nodeUrl: 'https://rpc.betanet.near.org',
      contractName: CONTRACT_NAME,
      walletUrl: 'https://wallet.betanet.near.org',
      helperUrl: 'https://helper.betanet.near.org',
      explorerUrl: 'https://explorer.betanet.near.org',
    }
  case 'local':
    return {
      networkId: 'local',
      nodeUrl: 'http://localhost:3030',
      keyPath: `${process.env.HOME}/.near/validator_key.json`,
      walletUrl: 'http://localhost:4000/wallet',
      contractName: CONTRACT_NAME,
    }
  case 'test':
  case 'ci':
    return {
      networkId: 'shared-test',
      nodeUrl: 'https://rpc.ci-testnet.near.org',
      contractName: CONTRACT_NAME,
      masterAccount: 'test.near',
    }
  case 'ci-betanet':
    return {
      networkId: 'shared-test-staging',
      nodeUrl: 'https://rpc.ci-betanet.near.org',
      contractName: CONTRACT_NAME,
      masterAccount: 'test.near',
    }
  default:
    throw Error(`Unconfigured environment '${env}'. Can be configured in src/config.js.`)
  }
}

const nearConfig = getConfig('development')
const near = await connect(Object.assign({ deps: { keyStore: new keyStores.BrowserLocalStorageKeyStore() } }, nearConfig))

// Initializing Wallet based Account. It can work with NEAR testnet wallet that
// is hosted at https://wallet.testnet.near.org
window.walletConnection = new WalletConnection(near)

// Getting the Account ID. If still unauthorized, it's just empty string
window.accountId = window.walletConnection.getAccountId()

// Initializing our contract APIs by contract name and configuration
window.contract = await new Contract(window.walletConnection.account(), nearConfig.contractName, {
  // View methods are read only. They don't modify the state, but usually return some value.
  viewMethods: ['get_item', 'get_items_by_newest'],
  // Change methods can modify the state. But you don't receive the returned value when called.
  changeMethods: ['register_log'],
})

function logout() {
  window.walletConnection.signOut()
  // reload page
  window.location.replace(window.location.origin + window.location.pathname)
}

function login() {
  // Allow the current app to make calls to the specified contract on the
  // user's behalf.
  // This works by creating a new access key for the user's account and storing
  // the private key in localStorage.
  window.walletConnection.requestSignIn(nearConfig.contractName)
}

window.login = login
window.logout = logout


// ==================================================================
// import { NFTStorage } from 'nft.storage'

async function store_nft(markdown_text, api_key, autosaveUniqueId) {
  var title = markdown_text.split("\n")[0].trim().replaceAll('# ', '').substr(0, 50);
  var bearer = "Bearer " + api_key;

  var nft = {
    image: null,  // simple bro, no need image. 
    name: title,
    description: null,
    properties: {
      author: window.walletConnection.getAccountId(),
      content: {
        "text/markdown": markdown_text
      }
    }
  }

  fetch('https://api.nft.storage/upload', {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": bearer
    },
    body: JSON.stringify(nft)
  }).then((resp) => {
    return resp.json();
  }).then((jsonResp) => {
    console.log(jsonResp);
    var dataValue = jsonResp.value;

    if (jsonResp.ok == true) {
      alert("Successfully saved.");
      localStorage.removeItem(autosaveUniqueId);

      window.contract.register_log({
        callbackUrl: window.location.origin,
        args: {
          "cid": dataValue.cid
        },
        gas: "300000000000000",
        amount: 0
      },);

    } else {
      alert("Failed to save.");
      console.log(jsonResp.error);
    }
  })
}


async function get_nft(cid) {
    var response = await fetch('https://ipfs.io/ipfs/' + cid);

    if (!response.ok) {
      return { "error": "Response have problem." };
    }

    var jsonResp = await response.json();
    return jsonResp;
}

window.store_nft = store_nft
window.get_nft = get_nft
</script>
  <!-- Custom Style Outside of Bootstrap -->
<style>
  ::selection {
    color: inherit;
    background: lightblue;
  }

  .no_link {
    color: inherit;
    text-decoration: inherit;
  }
</style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">WriteLog</a>

    <button
      class="navbar-toggler bg-light"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarTogglerDemo02"
      aria-controls="navbarTogglerDemo02"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a href="/write" id="write" class="nav-link"></a>
        </li>

        <li class="nav-item">
          <a href="#" id="address" class="nav-link"></a>
        </li>

        <li class="nav-item">
          <a href="/about" class="nav-link">About</a>
        </li>

        <li class="nav-item">
          <a href="#" id="login" class="nav-link">Login</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<script>
window.addEventListener("load", function () {
  const login = document.getElementById("login");
  const address = document.getElementById("address");
  const write = document.getElementById("write");

  if (window.walletConnection.getAccountId() == '') {
    login.onclick = window.login;
    address.innerText = "";
    write.innerText = "";
  } else {
    login.onclick = window.logout;
    login.innerText = "Logout";
    address.innerText = window.walletConnection.getAccountId();
    write.innerText = "Write";
  }
  
})
</script>
  
  %CONTENT%
</body>

<footer class="footer fixed-bottom text-center text-lg-start bg-light text-muted">
  <section class="d-flex justify-content-center justify-content-lg-between border-bottom">
    <div class="me-5 d-none d-lg-block">
      <small>
        <a href="/about">Design Ideas</a>
      </small>
    </div>
  </section>
</footer>